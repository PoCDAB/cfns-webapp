{% extends "base.html" %}
{% load static %}

{% load leaflet_tags %}

{% block title %}
  <title>Geoview</title>
{% endblock %}

{% block head %}
    {% leaflet_js %}
    {% leaflet_css %}
    <link rel="stylesheet" type="text/css" href="{% static '/css/geoview.css' %}">
    <script type="text/javascript" src="{% static '/js/leaflet.ajax.js' %}"></script>
    <script type="text/javascript" src="{% static '/js/leaflet.rotateMarker.js' %}"></script>
{% endblock %}

{% block body-fluid %}

<div class="container-fluid">
  <div class="d-flex flex-wrap">
    <div class="col-lg-2">
      <h3 class="m-2">Filters:</h3>
      <form method="post">
        {% csrf_token %}
        <table class="d-flex justify-content-center">
          {% if form.subject.errors %}
            <ol role="alertdialog">
                {% for error in form.subject.errors %}
                <li role="alert"><strong>{{ error|escape }}</strong></li>
                {% endfor %}
            </ol>
            {% endif %}
    
            <table class="table table-hover">
              <tbody>
            {% for field in form %}
                <tr class="m-0 p-0">
                  <td class="col-lg-1">
                    {{ field }}
                    {% if field.help_text %}
                      <p class="help">{{ field.help_text|safe }}</p>
                    {% endif %}
                  </td>
                  <td class="m-0 p-0 col-lg-11">
                    {{ field.label_tag }}{% if field.field.required %}<span class="required">*</span>{% endif %}
                  </td>
                </tr>
          {% endfor %}
        </tbody>
        </table>
        <button class="btn btn-success w-100" type="submit">Toepassen</button>
      </form>
    </div>
    <div class="col-lg-8">
      <script>
        

        function map_init (map, options) {
          function Icon(iconpath) {
            return L.icon({
              iconUrl: iconpath,
              iconSize:     [38, 38], // size of the icon
              popupAnchor:  [0, -10], // point from which the popup should open relative to the iconAnchor
            });
          }

          // Use Leaflet API here
          var datasets = new L.GeoJSON.AJAX("{% url 'ais-data' %}", {
              pointToLayer: function(feature, latlng) {
                if (feature.properties?.mmsi < 1000) {
                  var colouredIcon = Icon("{% static 'img/bluearrow.png' %}");
                } else {
                  var colouredIcon = Icon("{% static 'img/greenarrow.png' %}");
                }
                return L.marker(latlng, { icon: colouredIcon, rotationAngle: feature.properties.course })
              },
              onEachFeature: function (feature, layer) {
                layer.bindPopup(
                "<h6 class='text-center'>AIS</h6>" +
                "<b>MMSI:</b> " + (feature.properties?.mmsi?.toString() || "<i>Niet bekend</i>")  +
                "</br><b>Schipnaam:</b> " + (feature.properties?.name?.toString() || "<i>Niet bekend</i>") +
                "</br><b>Koers:</b> " + (feature.properties?.course?.toString() || "<i>Niet bekend</i>") +
                "</br><b>Laatste ping:</b> " + (feature.properties?.updated_at?.toString() || "<i>Niet bekend</i>") 

              )}
          }).addTo(map);

          var datasets = new L.GeoJSON.AJAX("{% url 'ais-data' %}", {
              onEachFeature: function (feature, layer) {
                layer.bindPopup(
                "<h6 class='text-center'>AIS</h6>" +
                "<b>MMSI:</b> " + (feature.properties?.mmsi?.toString() || "<i>Niet bekend</i>")  +
                "</br><b>Schipnaam:</b> " + (feature.properties?.name?.toString() || "<i>Niet bekend</i>") +
                "</br><b>Koers:</b> " + (feature.properties?.course?.toString() || "<i>Niet bekend</i>") +
                "</br><b>Laatste ping:</b> " + (feature.properties?.updated_at?.toString() || "<i>Niet bekend</i>") 

              )}
          }).addTo(map);
        }
      </script>
      {% leaflet_map "geoview" callback="window.map_init" %}
    </div>
    <div class="col-lg-2">
      <h3 class="m-2">Legenda:</h3>

      Ruimte voor een legenda.
    </div>
  </div>
</div>
{% endblock %}
